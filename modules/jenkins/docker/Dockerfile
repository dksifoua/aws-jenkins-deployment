FROM jenkins/jenkins:lts-jdk17
LABEL authors="Dimitri Sifoua"
LABEL description="Jenkins CI/CD Server"
LABEL maintainer="Dimitri Sifoua <dimitri.sifoua@gmail.com>"
LABEL repository="dksifoua"
LABEL version="1.4.0"

ARG AWS_ACCESS_KEY_ID
ARG AWS_SECRET_ACCESS_KEY
ARG ENV=production
ARG GITHUB_ACCESS_TOKEN
ARG GITHUB_USER
ARG JCASC_CONFIG_PATH
ARG JENKINS_ADMIN_DESC
ARG JENKINS_ADMIN_EMAIL
ARG JENKINS_ADMIN_NAME
ARG JENKINS_ADMIN_PASS
ARG JENKINS_ADMIN_USER
ARG PLUGINS_FILE
ARG SCRIPTS_PATH

ENV AWS_ACCESS_KEY_ID $AWS_ACCESS_KEY_ID
ENV AWS_SECRET_ACCESS_KEY $AWS_SECRET_ACCESS_KEY
ENV CASC_JENKINS_CONFIG $JENKINS_HOME/casc_configs
ENV ENV $ENV
ENV GITHUB_ACCESS_TOKEN $GITHUB_ACCESS_TOKEN
ENV GITHUB_USER $GITHUB_USER
ENV JENKINS_ADMIN_DESC $JENKINS_ADMIN_DESC
ENV JENKINS_ADMIN_EMAIL $JENKINS_ADMIN_EMAIL
ENV JENKINS_ADMIN_NAME $JENKINS_ADMIN_NAME
ENV JENKINS_ADMIN_PASS $JENKINS_ADMIN_PASS
ENV JENKINS_ADMIN_USER $JENKINS_ADMIN_USER

USER jenkins

COPY ${JCASC_CONFIG_PATH}/*.yaml $CASC_JENKINS_CONFIG/
COPY ${PLUGINS_FILE} $REF/plugins.txt

RUN <<EOF
  echo 2.0 > $REF/jenkins.install.UpgradeWizard.state
  jenkins-plugin-cli -f $REF/plugins.txt
EOF